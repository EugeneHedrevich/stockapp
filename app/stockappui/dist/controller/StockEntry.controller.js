sap.ui.define(["./BaseController","sap/ui/core/routing/History","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,o,n){"use strict";const r=e=>e===undefined||e===null||String(e).trim()==="";return e.extend("stockappui.controller.StockEntry",{onInit(){this.getView().addEventDelegate({onAfterShow:()=>this.addFunctionKeyListener?.(),onAfterHide:()=>this.removeFunctionKeyListener?.()})},pressKeyOnKeyboard(e){switch(e){case"Enter":case"F4":this.onConfirm();break;case"F1":this.onOpenTopHU();break;case"F2":this.onOpenSerNb();break;case"F6":this.onOpenList();break;case"F7":case"Escape":this.onNavBack();break}},onNavBack(){const e=t.getInstance();if(e.getPreviousHash()!==undefined)return window.history.go(-1);const o=this.getOwnerComponent().getModel("vm");this.getRouter().navTo("RouteStorageBin",{warehouse:encodeURIComponent(o.getProperty("/warehouse")||"")})},onOpenTopHU(){const e=this.getOwnerComponent().getModel("vm");this.getRouter().navTo("RouteSubAction",{mode:"TopHU",warehouse:encodeURIComponent(e.getProperty("/warehouse")||""),bin:encodeURIComponent(e.getProperty("/bin")||"")})},onOpenSerNb(){const e=this.getOwnerComponent().getModel("vm");this.getRouter().navTo("RouteSubAction",{mode:"SerNb",warehouse:encodeURIComponent(e.getProperty("/warehouse")||""),bin:encodeURIComponent(e.getProperty("/bin")||"")})},onOpenList(){const e=this.getOwnerComponent().getModel("vm");this.getRouter().navTo("RouteSubAction",{mode:"List",warehouse:encodeURIComponent(e.getProperty("/warehouse")||""),bin:encodeURIComponent(e.getProperty("/bin")||"")})},onConfirm:async function(){const e=this.getOwnerComponent().getModel("vm");const t=e.getProperty("/entry")||{};const s=e.getProperty("/serials")||[];const a=!r(t.product);const i=!r(t.quantity);const c=!r(t.hu);if(!c&&!a&&!i){n.error(this.getI18nText("errConfirmMinReq"));return}if(a&&!i){n.error(this.getI18nText("errProductNeedsQty"));return}if(i&&isNaN(Number(t.quantity))){n.error(this.getI18nText("errQtyNumeric"));return}if(!a&&i){n.error(this.getI18nText("errQtyNoProduct"));return}const u=e.getProperty("/warehouse");const l=e.getProperty("/bin");const p={warehouse:u,storageBin:l,topHU:e.getProperty("/__sub/topHu")||null,packMatTopHU:t.packMat||null,stockHU:t.hu||null,packMatStockHU:t.packMat||null,product:t.product||null,batch:t.batch||null,quantity:i?Number(t.quantity):null,uom:t.uom||null};try{this.showBusyIndicator();let t;if(s.length>0){t=await this.callAction("ConfirmStockWithSerials",{entry:p,serials:s})}else{t=await this.callAction("ConfirmStock",{entry:p})}e.setProperty("/hostPhysicalStockId",t?.id||t?.ID||null);e.setProperty("/entry/quantity",t?.quantity??null);e.setProperty("/serials",[]);await this.onExportExcel(u,l);o.show(this.getI18nText("msgConfirmSuccess"));e.setProperty("/entry",{hu:"",packMat:"",product:"",batch:"",quantity:null,uom:""});e.setProperty("/__sub/topHu","")}catch(e){this.showActionError(e,"Confirm failed")}finally{this.hideBusyIndicator()}},onExportExcel:async function(e,t){try{const o=await this.callAction("ExportPhysicalStockExcel",{warehouse:e,storageBin:t});const n="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";let r;if(o?.value?.type==="Buffer"&&Array.isArray(o.value.data)){const e=new Uint8Array(o.value.data);r=new Blob([e],{type:n})}else if(o?.type==="Buffer"&&Array.isArray(o.data)){const e=new Uint8Array(o.data);r=new Blob([e],{type:n})}else if(o instanceof ArrayBuffer){r=new Blob([new Uint8Array(o)],{type:n})}else if(o?.buffer instanceof ArrayBuffer){r=new Blob([new Uint8Array(o.buffer)],{type:n})}else if(typeof o==="string"){const e=atob(o);const t=new Uint8Array(e.length);for(let o=0;o<e.length;o++)t[o]=e.charCodeAt(o);r=new Blob([t],{type:n})}else{throw new Error("Unexpected Excel payload type")}const s=URL.createObjectURL(r);const a=document.createElement("a");a.href=s;a.download="PhysicalStock.xlsx";a.click();URL.revokeObjectURL(s)}catch(e){sap.m.MessageBox.error("Excel export failed")}},onLiveChange(){}})});
//# sourceMappingURL=StockEntry.controller.js.map