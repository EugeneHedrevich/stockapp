sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,s,n,o){"use strict";function a(e,n){if(!Array.isArray(n)||n.length===0)return null;const o=[];for(const a of n){const n=a.operator||"EQ";const i=a.values?.[0];const r=a.values?.[1];if(i===undefined||i===null||i==="")continue;switch(n){case"BT":if(r!==undefined&&r!==null&&r!=="")o.push(new t(e,s.BT,i,r));break;case"Contains":o.push(new t(e,s.Contains,i));break;case"StartsWith":o.push(new t(e,s.StartsWith,i));break;case"EndsWith":o.push(new t(e,s.EndsWith,i));break;case"NE":o.push(new t(e,s.NE,i));break;case"LT":o.push(new t(e,s.LT,i));break;case"LE":o.push(new t(e,s.LE,i));break;case"GT":o.push(new t(e,s.GT,i));break;case"GE":o.push(new t(e,s.GE,i));break;default:o.push(new t(e,s.EQ,i));break}}if(!o.length)return null;return o.length===1?o[0]:new t({and:false,filters:o})}function i(e){return Array.isArray(e)&&e[0]?.values?.[0]?String(e[0].values[0]).trim():""}return e.extend("monitoringui.controller.PhysicalOverview",{onInit(){const e=new sap.ui.model.json.JSONModel({saveEnabled:false,busy:false,pendingCount:0,deleteEnabled:false,downloadEnabled:false});this.getView().setModel(e,"ui");this._pendingEdits=new Map},_getSelectedContext:function(){const e=this.byId("physTable").getSelectedContexts();return e&&e.length?e[0]:null},_updateSaveState(){const e=this.getView().getModel("ui");const t=this._pendingEdits.size>0;e.setProperty("/saveEnabled",t);e.setProperty("/pendingCount",this._pendingEdits.size)},async onSave(){const e=this.getView().getModel("ui");const t=Array.from(this._pendingEdits.values()).map(e=>({warehouse:e.scope.warehouse,storageBin:e.scope.storageBin,topHU:e.scope.topHU,stockHU:e.scope.stockHU,product:e.scope.product,currentBatch:e.currentBatch,newBatch:e.newBatch,uom:e.uom,newTotalQuantity:e.newTotalQuantity}));if(!t.length){sap.m.MessageToast.show("No changes to save.");return}e.setProperty("/busy",true);e.setProperty("/saveEnabled",false);const s=this.getView().getModel();const n=this.byId("physTable");try{const e=s.bindContext("/EditStock(...)");e.setParameter("edits",t);await e.execute();sap.m.MessageToast.show("Saved.");this._pendingEdits.clear();this._updateSaveState();n.getBinding("items")?.refresh()}catch(e){sap.m.MessageBox.error(e?.message||"Save failed.");this._updateSaveState()}finally{e.setProperty("/busy",false)}},onCellLiveChange(e){const t=e.getSource();const s=t.getParent();const n=s.getBindingContext();if(!n)return;const o=n.getObject();const a=o.ID;const i=t.getCustomData().find(e=>e.getKey()==="field")?.getValue();if(!this._pendingEdits.has(a)){this._pendingEdits.set(a,{scope:{warehouse:o.warehouse,storageBin:o.storageBin,topHU:o.topHU??null,stockHU:o.stockHU??null,product:o.product??null},currentBatch:o.batch??null,newBatch:o.batch??null,uom:o.uom??null,newTotalQuantity:Number(o.quantity)||0})}const r=this._pendingEdits.get(a);if(i==="batch")r.newBatch=t.getValue()||null;else if(i==="quantity")r.newTotalQuantity=Number(t.getValue()||0);const c=(r.newBatch??"")===(r.currentBatch??"")&&Number(r.newTotalQuantity)===Number(o.quantity||0);if(c)this._pendingEdits.delete(a);this._updateSaveState()},onSelectionChange(e){const t=e.getSource();const s=t.getSelectedItems().length>0;const n=this.getView().getModel("ui");n.setProperty("/downloadEnabled",s);n.setProperty("/deleteEnabled",s)},onFBSearch:function(){const e=this.byId("physTable").getBinding("items");if(!e)return;const t=e=>this.byId(e).getConditions();const s=[a("warehouse",t("ffWarehouse")),a("storageBin",t("ffBin")),a("stockHU",t("ffStockHU")),a("topHU",t("ffTopHU")),a("product",t("ffProduct")),a("batch",t("ffBatch"))].filter(Boolean);const n=i(t("ffSearch"));if(typeof e.changeParameters==="function"){e.changeParameters({$search:n||undefined})}e.filter(s,"Application")},onDeleteRow:function(){const e=this._getSelectedContext();if(!e){n.show("Select a row first");return}o.confirm("Delete the selected row?",{actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK,onClose:async t=>{if(t!==o.Action.OK)return;try{await e.delete();n.show("Row deleted");this.byId("physTable").removeSelections(true);this.byId("btnDownload").setEnabled(false);this.byId("btnDelete").setEnabled(false);const t=this.byId("physTable").getBinding("items");if(t)t.refresh()}catch(e){o.error(e?.message||"Delete failed")}}})},onDownloadSerials:function(){const e=this._getSelectedContext();if(!e){n.show("Select a row first");return}const o=e.getProperty("warehouse");const a=e.getProperty("storageBin");const i=e.getProperty("topHU");const r=e.getProperty("stockHU");const c=e.getProperty("product");const l=[new t("warehouse",s.EQ,o),new t("storageBin",s.EQ,a)];if(i)l.push(new t("topHU",s.EQ,i));if(r)l.push(new t("stockHU",s.EQ,r));if(c)l.push(new t("product",s.EQ,c));const u=this.byId("serialsTable");u.unbindItems();u.removeAllItems();const d=this.byId("serialsItemTemplate").clone();u.bindItems({path:"/SerialNumbers",template:d,templateShareable:false,filters:l});this.byId("serialsHint").setText(`Serials for ${o} / ${a} / ${c||"(no product)"} / TopHU ${i||"–"} / StockHU ${r||"–"}`);n.show("Serial numbers loaded")},onRefresh:function(){const e=this.byId("physTable");const t=this.byId("serialsTable");const s=e.getBinding("items");const o=t.getBinding("items");e.setBusy(true);if(o)t.setBusy(true);if(s){s.attachEventOnce("dataReceived",()=>e.setBusy(false));s.refresh()}else{e.setBusy(false)}if(o){o.attachEventOnce("dataReceived",()=>t.setBusy(false));o.refresh()}n.show("Refreshing data…")},onStartEdit:function(){n.show("Edit mode is disabled in this screen.")}})});
//# sourceMappingURL=PhysicalOverview.controller.js.map